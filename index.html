<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BAR BOSS — инвентаризация (v3.12.0)</title>
<meta name="theme-color" content="#0e0f13">
<style>
html,body{height:100%}
*{box-sizing:border-box}
body{margin:0;background:#0e0f13;color:#f5f5f5;font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 16px;border-bottom:1px solid #1f2230;background:#0e0f13;position:sticky;top:0;z-index:5;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:900}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #1f2230;border-radius:10px;background:#0b0d16;color:#fff;cursor:pointer}
.tab.active{background:#ffd400;color:#111;font-weight:800}
.profile-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.profile-bar label{font-size:12px;color:#a3a8b3}
select,button,input,textarea{font-family:inherit}
input,select,textarea{width:100%;height:44px;padding:0 10px;border-radius:10px;border:1px solid #2a2e3f;background:#0b0d16;color:#fff;min-width:0}
button{height:44px;border-radius:10px;border:0;background:#ffd400;color:#111;font-weight:800;padding:0 14px;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
button.sec{background:#171a28;color:#fff;border:1px solid #2a2e3f}
button.ok{background:#2ecc71;color:#fff}
button.warn{background:#ff9500;color:#111}
button.danger{background:#ff3b30;color:#fff}
.card{background:#121420;border:1px solid #1f2230;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.35);overflow:hidden;margin-top:16px}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2230;background:#0f111a;font-size:18px}
.card .body{padding:14px}
.grid{display:grid;gap:12px}
.grid-3{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.row{display:grid;gap:6px;min-width:0}
label{font-size:12px;color:#a3a8b3}
input.invalid{border-color:#ff3b30;outline:0;box-shadow:0 0 0 1px #ff3b30 inset}
.actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.result{padding:10px;border:1px dashed #2a2e3f;border-radius:10px;background:#0b0d16;margin-top:10px}
.big{font-size:24px;font-weight:900;color:#ffd400}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2a2e3f;background:#0b0d16;color:#9aa;font-size:12px;margin-right:6px;margin-top:4px}
.kv{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.footer{opacity:.7;font-size:12px;margin-top:8px}
.hidden{display:none !important}
#modal{display:flex}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #1f2230;text-align:left}
.small{height:36px;font-size:14px;padding:0 10px}
.muted{color:#a3a8b3;font-size:12px}
.link{color:#ffd400;cursor:pointer}
.sticky-actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
@media (max-width: 560px){
  .sticky-actions{position:sticky;bottom:8px;z-index:4;background:#121420d9;backdrop-filter:saturate(120%) blur(6px);padding:8px;border-radius:12px;border:1px solid #1f2230}
}
/* Accordion */
details{border:1px solid #1f2230;border-radius:12px;background:#0b0d16}
details+details{margin-top:10px}
summary{cursor:pointer;list-style:none;padding:10px 12px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
summary::-webkit-details-marker{display:none}
.cat-title{font-weight:800}
.subgroup{padding:8px 12px;border-top:1px solid #1f2230}
.sub-title{font-weight:700;margin:6px 0}
.db-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid #1f2230;border-radius:10px;background:#0f111a;margin-top:8px}
.db-fields{display:flex;flex-wrap:wrap;gap:6px}
.db-fields .badge{margin-right:6px;margin-top:0}
.db-actions{display:flex;gap:8px}
</style>
</head>
<body>

<!-- ШАПКА -->
<div class="header">
  <div class="left" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>BAR BOSS • v3.12.0</h1>
    <div class="tabs">
      <button class="tab active" data-tab="calc" type="button">Калькулятор</button>
      <button class="tab" data-tab="db" type="button">База</button>
      <button class="tab" data-tab="session" type="button">Сессия</button>
    </div>
  </div>
  <div class="profile-bar">
    <label for="profile-select">Профиль:</label>
    <select id="profile-select" class="small"></select>
    <button id="profile-add" class="small sec" type="button">Добавить профиль</button>
    <button id="profile-del" class="small danger" type="button">Удалить профиль</button>
  </div>
</div>

<div class="container">

  <!-- КАЛЬКУЛЯТОР -->
  <section id="tab-calc" class="card">
    <h2>Калькулятор по профилю бутылки</h2>
    <div class="body">
      <div class="grid grid-3">
        <div class="row"><label>Вид алкоголя</label><select id="cat-select"></select></div>
        <div class="row"><label>Подкатегория</label><select id="subcat-select"></select></div>
        <div class="row"><label>Поиск</label><input id="search-bottle" placeholder="Начните печатать..."></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="row"><label>Бутылка</label><select id="bottle-select"></select></div>
        <div class="row"><label>&nbsp;</label>
          <div class="actions">
            <button class="sec" id="btn-add-bottle" type="button">Добавить</button>
          </div>
        </div>
        <div class="row"></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="row"><label>Номинал, мл</label><input id="cap" disabled></div>
        <div class="row"><label>Крепость, %</label><input id="abv" disabled></div>
        <div class="row"><label>Пустая тара, г</label><input id="tare" disabled></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="row"><label>Вес сейчас, г</label><input id="gross" type="number" inputmode="decimal" placeholder="например, 1009"></div>
        <div class="row"><label>Высота бутылки, см</label><input id="hTot" type="number" inputmode="numeric" placeholder="например, 22"></div>
        <div class="row"><label>Уровень жидкости, см</label><input id="hLiq" type="number" inputmode="numeric" placeholder="например, 10"></div>
      </div>

      <div class="sticky-actions" style="margin-top:8px">
        <button class="ok" id="calc" type="button">Рассчитать</button>
        <div id="note" class="muted"></div>
        <label style="display:flex;align-items:center;gap:8px;margin-left:auto;font-size:13px;color:#a3a8b3">
          <input id="auto-session" type="checkbox" style="width:16px;height:16px"> Автодобавлять в сессию
        </label>
        <button class="sec" id="btn-refresh" type="button" title="Обновить кэш">Обновить кэш</button>
      </div>

      <div id="res" class="result"></div>
      <div class="row" style="margin-top:10px">
        <label>Паспорт выбранной бутылки</label>
        <div id="passport" class="result"></div>
      </div>
    </div>
  </section>

  <!-- БАЗА -->
  <section id="tab-db" class="card hidden">
    <h2>База бутылок</h2>
    <div class="body">
      <div id="db-toolbar" class="actions" style="margin-bottom:8px">
        <button id="db-add" class="sec" type="button">Добавить бутылку</button>
        <label class="muted">Разделитель CSV</label>
        <select id="csv-delim" class="small"><option value=",">Запятая (,)</option><option value=";">Точка с запятой (;)</option></select>
        <button id="db-export-csv" class="small" type="button">Экспорт CSV</button>
        <button id="db-import-csv" class="small sec" type="button">Импорт CSV</button>
        <input id="file-csv" type="file" accept=".csv,text/csv" class="hidden">
        <input id="db-search" class="small" placeholder="Поиск по базе..." style="min-width:260px">
        <div id="db-msg" class="badge"></div>
      </div>
      <div id="db-accordion"></div>
    </div>
  </section>

  <!-- СЕССИЯ -->
  <section id="tab-session" class="card hidden">
    <h2>Сессия инвентаризации</h2>
    <div class="body">
      <div class="actions">
        <button id="sess-new" class="ok" type="button">Новая сессия</button>
        <label class="muted">Разделитель CSV</label>
        <select id="csv-delim2" class="small"><option value=",">Запятая (,)</option><option value=";">Точка с запятой (;)</option></select>
        <button id="sess-export-csv" class="small sec" type="button">Экспорт CSV</button>
        <div class="badge" id="sess-info"></div>
      </div>
      <div class="grid grid-3">
        <div class="row"><label>Поиск бутылки</label><input id="sess-search" placeholder="Название..."></div>
        <div class="row"><label>Бутылка</label><select id="sess-bottle"></select></div>
        <div class="row"><label>&nbsp;</label><button id="sess-add-row" type="button">Добавить строку</button></div>
      </div>
      <div class="result" style="overflow:auto">
        <table class="table" id="sess-table">
          <thead><tr><th>#</th><th>Бутылка</th><th>Вес, г</th><th>Высота, см</th><th>Уровень, см</th><th>Объём, мл</th><th>%</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="footer">BAR BOSS • GitHub Pages • локальные профили и сессии изолированы по устройству/браузеру.</div>
</div>

<!-- МОДАЛ «Добавить бутылку» -->
<div id="modal" class="hidden"
     style="position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:50;padding:16px">
  <div class="box" style="max-width:640px;width:100%;background:#0f111a;border:1px solid #2a2e3f;border-radius:16px;overflow:hidden">
    <h3 style="margin:0;padding:12px 14px;border-bottom:1px solid #2a2e3f;background:#121420">Добавить бутылку</h3>
    <div class="body" style="padding:14px">
      <div class="grid grid-3">
        <div class="row"><label>Вид алкоголя</label><select id="m-cat"></select></div>
        <div class="row"><label>Подкатегория</label><select id="m-sub"></select></div>
        <div class="row"><label>Наименование</label><input id="m-name" placeholder="Например, Tanqueray 700"></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="row"><label>Номинал, мл</label><input id="m-cap" type="number" inputmode="numeric" placeholder="например, 700"></div>
        <div class="row"><label>Крепость, %</label><input id="m-abv" type="number" inputmode="decimal" placeholder="например, 40"></div>
        <div class="row"><label>Пустая тара, г</label><input id="m-tare" type="number" inputmode="numeric" placeholder="например, 420"></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="m-save" type="button">Сохранить</button>
        <button id="m-cancel" class="sec" type="button">Отмена</button>
        <div id="m-msg" class="badge"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';
var VER='3.12.0';
function $(id){return document.getElementById(id)}
function qsa(s){return document.querySelectorAll(s)}
function fmt(n){return isFinite(n)?Math.round(n):0}
function slug(s){return (String(s||'').toLowerCase().replace(/[^a-z0-9а-яё]+/gi,'-').replace(/^-+|-+$/g,'')+'-'+Math.floor(Math.random()*1e6).toString(36))}
function uniqKey(n,c,sb){return [String(n||'').trim().toLowerCase(),String(c||'').toLowerCase(),String(sb||'').toLowerCase()].join('||')}
var mem={},lsOK=false;try{var k='__bb__'+Math.random();localStorage.setItem(k,'1');localStorage.removeItem(k);lsOK=true}catch(e){lsOK=false}
function getStore(key,def){try{if(lsOK){var v=localStorage.getItem(key);return v?JSON.parse(v):def}}catch(e){}return (mem[key]!==undefined)?mem[key]:def}
function setStore(key,val){try{if(lsOK){localStorage.setItem(key,JSON.stringify(val));return}}catch(e){}mem[key]=val}
function delStore(key){try{if(lsOK){localStorage.removeItem(key)}}catch(e){}}

var CATEGORIES={
 "Водка":["Классическая","Пшеничная","Ржаная","Картофельная","Ароматизированная"],
 "Виски":["Шотландский купажированный","Шотландский односолодовый","Ирландский","Бурбон","Ржаной","Кукурузный","Теннессийский","Канадский","Японский","Японский односолодовый","Японский купажированный"],
 "Бренди (виноградный/фруктовый)":["Коньяк","Арманьяк","Кальвадос","Писко","Граппа/Марка","Орухо","Виноградный бренди (общ.)","Сливовица/Ракия","Абрикосовый/Грушевый"],
 "Ром":["Лёгкий (кубинский)","Золотой","Тёмный","Пряный","Ямайский","Демерара","Барбадос","Агриколь","Navy/Overproof"],
 "Кашаса":["Белая","Золотая/Отлежавшая","Пряная/Ароматизированная"],
 "Текила":["Бланко","Репосадо","Аньехо","Экстра Аньехо","Миксто"],
 "Мескаль и агавовые":["Мескаль (энсабле)","Мескаль (односортовой)","Бакынора","Райсилья","Сотоль"],
 "Джин и семейство":["Лондонский сухой","Олд Том","Плимутский","Дженевер/Йеневер","Sloe gin"],
 "Анисовые":["Абсент","Пастис","Узо","Самбука","Арак (Левант)"],
 "Аквавит":["Дилла/Тмин","Кардамон/Пряный","Прочие скандинавские стили"],
 "Амаро/горькие ликёры":["Фернет","Итальянские амаро (общ.)","Травяные биттер-ликёры"],
 "Ликёры (сладкие)":["Цитрусовые (Triple Sec/Куантро/Курасао)","Кофейные","Ореховые","Сливочные","Фруктовые","Цветочные/Травяные"],
 "Вермуты и аперитивы":["Вермут сухой","Вермут сладкий","Bianco/Extra-Dry","Биттер-аперитив (красный)","Амер"],
 "Укреплённые вина":["Херес (общ.)","Портвейн (общ.)","Мадера"],
 "Азиатские дистилляты":["Байцзю — соусный аромат","Байцзю — сильный аромат","Байцзю — лёгкий аромат","Байцзю — рисовый аромат","Сётю — имо (батат)","Сётю — комэ (рис)","Сётю — муги (ячмень)","Ауамори — классический","Ауамори — кусу (выдержанный)","Соджу — классический","Соджу — ароматизированный","Арак — Батавия","Арак — кокосовый (Шри-Ланка)","Фени — кокос","Фени — кешью","Ламбаног","Лао-Лао"]
};

var DEFAULT_DB=[
  {id:"absolut-700",name:"Absolut Vodka 700",category:"Водка",subcat:"Классическая",cap_ml:700,abv_pct:40,tare_g:420},
  {id:"jack-700",name:"Jack Daniel’s 700",category:"Виски",subcat:"Теннессийский",cap_ml:700,abv_pct:40,tare_g:500},
  {id:"olmeca-750",name:"Olmeca Blanco 750",category:"Текила",subcat:"Бланко",cap_ml:750,abv_pct:40,tare_g:600}
];

var DB=getStore('bb_db_v311',DEFAULT_DB.slice());
function saveDB(){setStore('bb_db_v311',DB)}
function DBMAP(){var o={};for(var i=0;i<DB.length;i++){o[DB[i].id]=DB[i]}return o}

function setOptions(el,arr,withAll){var h=withAll?'<option value="">Все</option>':'';for(var i=0;i<arr.length;i++)h+='<option>'+arr[i]+'</option>';el.innerHTML=h}
function fillCats(){ setOptions($('cat-select'), Object.keys(CATEGORIES), false) }
function fillSubs(){ setOptions($('subcat-select'), CATEGORIES[$('cat-select').value]||[], true) }
function fillBottles(){
  var cat=$('cat-select').value, sub=$('subcat-select').value, q=String($('search-bottle').value||'').toLowerCase();
  var list=DB.filter(b=>(!cat||b.category===cat)&&(!sub||sub==='Все'||b.subcat===sub)&&(!q||b.name.toLowerCase().includes(q)));
  list.sort((a,b)=>a.name.localeCompare(b.name));
  $('bottle-select').innerHTML=list.map(b=>'<option value="'+b.id+'">'+b.name+'</option>').join('');
  if(list.length){loadPassport(list[0].id)}else{$('passport').innerHTML='';$('cap').value='';$('abv').value='';$('tare').value='';}
}
function loadPassport(id){
  var b=DBMAP()[id]; if(!b) return;
  $('bottle-select').value=b.id; $('cap').value=b.cap_ml; $('abv').value=b.abv_pct; $('tare').value=b.tare_g;
  $('passport').innerHTML='<span class="badge">'+b.category+' → '+b.subcat+'</span><span class="badge">'+b.cap_ml+' мл</span><span class="badge">'+b.abv_pct+'%</span><span class="badge">'+b.tare_g+' г</span>';
  saveCalcState();
}

// физика
function rhoBase(abv){abv=Math.max(0,Math.min(96,Number(abv)||0));var a0={abv:0,rho:1.0},a1={abv:40,rho:0.948},a2={abv:96,rho:0.805};if(abv<=a1.abv){var t=abv/(a1.abv-a0.abv);return a0.rho+t*(a1.rho-a0.rho)}var t2=(abv-a1.abv)/(a2.abv-a1.abv);return a1.rho+t2*(a2.rho-a1.rho)}
function vMass(net,abv){return net>0?net/rhoBase(abv):0}
function vGeom(cap,h,ht){return(!cap||!h||!ht||h<=0||ht<=0)?0:cap*Math.max(0,Math.min(1,h/ht))}

// валидатор / состояние
function isNum(n){return n!==''&&!isNaN(n)}
function validateCalc(){
  var ok=true, gross=$('gross'), hTot=$('hTot'), hLiq=$('hLiq'), arr=[gross,hTot,hLiq];
  arr.forEach(i=>i.classList.remove('invalid'));
  if(!isNum(gross.value)){gross.classList.add('invalid');ok=false}
  if(!isNum(hTot.value)||Number(hTot.value)<=0){hTot.classList.add('invalid');ok=false}
  if(!isNum(hLiq.value)||Number(hLiq.value)<0){hLiq.classList.add('invalid');ok=false}
  if(isNum(hLiq.value)&&isNum(hTot.value)&&Number(hLiq.value)>Number(hTot.value)){hLiq.classList.add('invalid');ok=false;$('note').textContent='Уровень не может быть выше высоты.'}else{ if($('note').textContent.startsWith('Уровень')) $('note').textContent='' }
  $('calc').disabled=!ok; return ok
}
function saveCalcState(){
  setStore('bb_calc_v311',{cat:$('cat-select').value,sub:$('subcat-select').value,q:$('search-bottle').value,id:$('bottle-select').value,gross:$('gross').value,hTot:$('hTot').value,hLiq:$('hLiq').value})
}
function loadCalcState(){
  var st=getStore('bb_calc_v311',null); if(!st) return;
  $('cat-select').value=st.cat||$('cat-select').value; fillSubs(); $('subcat-select').value=st.sub||'';
  $('search-bottle').value=st.q||''; fillBottles(); if(st.id&&DBMAP()[st.id]){$('bottle-select').value=st.id; loadPassport(st.id)}
  $('gross').value=st.gross||''; $('hTot').value=st.hTot||''; $('hLiq').value=st.hLiq||''; validateCalc();
}

// СЕССИИ И ПРОФИЛИ (изоляция)
var CLIENT=getStore('bb_client_id',null); if(!CLIENT){CLIENT='U'+Math.floor(Math.random()*1e9)+'-'+Date.now().toString(36); setStore('bb_client_id',CLIENT)}
function sessKeyFor(profileId){return 'bb_sess_v311_'+CLIENT+'__'+profileId}
var PROFILES=getStore('bb_profiles',[{id:'p1',name:'Профиль 1'}]);
var ACTIVE=getStore('bb_active_profile',PROFILES[0].id);
function getActiveProfile(){return ACTIVE}
function setActiveProfile(id){ACTIVE=id; setStore('bb_active_profile',id)}
function renderProfiles(){
  var html=''; for(var i=0;i<PROFILES.length;i++){html+='<option value="'+PROFILES[i].id+'">'+PROFILES[i].name+'</option>'}
  $('profile-select').innerHTML=html; $('profile-select').value=ACTIVE;
}
function addProfile(){
  var name=prompt('Название профиля:','Профиль '+(PROFILES.length+1)); if(!name) return;
  var id='p'+Math.floor(Math.random()*1e9).toString(36);
  PROFILES.push({id:id,name:name}); setStore('bb_profiles',PROFILES); setActiveProfile(id); renderProfiles(); loadSessionForActive()
}
function delProfile(){
  if(PROFILES.length<=1){alert('Нельзя удалить единственный профиль');return}
  if(!confirm('Удалить текущий профиль? Его сессия тоже будет удалена.')) return;
  var id=ACTIVE; PROFILES=PROFILES.filter(p=>p.id!==id); setStore('bb_profiles',PROFILES);
  delStore(sessKeyFor(id));
  setActiveProfile(PROFILES[0].id); renderProfiles(); loadSessionForActive();
}
$('profile-add').addEventListener('click',addProfile);
$('profile-del').addEventListener('click',delProfile);
$('profile-select').addEventListener('change',function(){ setActiveProfile(this.value); loadSessionForActive() });

// СЕССИЯ (по активному профилю)
var SESS={id:null,rows:[]};
function saveSESS(){ setStore(sessKeyFor(getActiveProfile()), SESS) }
function loadSessionForActive(){
  var st=getStore(sessKeyFor(getActiveProfile()),null);
  SESS = st || {id:null,rows:[]}; renderSess();
}
function sessNew(){SESS={id:('S'+Math.floor(Date.now()/1000)),rows:[]}; saveSESS(); renderSess()}
function sessBottleList(q){var list=DB.slice(); if(q){var st=String(q).toLowerCase(); list=list.filter(x=>x.name.toLowerCase().includes(st))} list.sort((a,b)=>a.name.localeCompare(b.name)); $('sess-bottle').innerHTML=list.map(x=>'<option value="'+x.id+'">'+x.name+'</option>').join('')}
function sessAddRow(){var id=$('sess-bottle').value,b=DBMAP()[id]; if(!b) return; SESS.rows.push({id:id,name:b.name,gross:0,hTot:0,hLiq:0,vol:0,pct:0}); saveSESS(); renderSess()}
function sessDel(i){SESS.rows.splice(i,1);saveSESS();renderSess()}
function sessRecalc(i){var r=SESS.rows[i],b=DBMAP()[r.id]; if(!b) return; var vm=vMass(Math.max(0,Number(r.gross||0)-b.tare_g),b.abv_pct), vg=vGeom(b.cap_ml,Number(r.hLiq||0),Number(r.hTot||0)); var V=(vm>0&&vg>0)?(vm+vg)/2:(vm>0?vm:vg); V=Math.max(0,Math.min(b.cap_ml,V)); r.vol=V; r.pct=b.cap_ml?Math.max(0,Math.min(100,V/b.cap_ml*100)):0}
function renderSess(){
  $('sess-info').textContent=SESS.id?('Сессия: '+SESS.id+' • позиций: '+SESS.rows.length):'Сессия не создана';
  var tb=$('sess-table').querySelector('tbody'); var html='';
  for(var i=0;i<SESS.rows.length;i++){var r=SESS.rows[i];
    html+='<tr data-i="'+i+'"><td>'+(i+1)+'</td><td><select class="r-bottle"></select></td>'+
    '<td><input class="r-gross" type="number" inputmode="decimal" value="'+(r.gross||'')+'"></td>'+
    '<td><input class="r-htot" type="number" inputmode="numeric" value="'+(r.hTot||'')+'"></td>'+
    '<td><input class="r-hliq" type="number" inputmode="numeric" value="'+(r.hLiq||'')+'"></td>'+
    '<td class="r-vol">'+fmt(r.vol||0)+'</td><td class="r-pct">'+fmt(r.pct||0)+'</td>'+
    '<td><span class="link" data-del="'+i+'">Удалить</span></td></tr>'
  }
  tb.innerHTML=html;
  var rows=tb.querySelectorAll('tr'); var list=DB.slice().sort((a,b)=>a.name.localeCompare(b.name));
  for(let j=0;j<rows.length;j++){(function(row){
    var i=parseInt(row.getAttribute('data-i'),10), sel=row.querySelector('.r-bottle'); sel.innerHTML=list.map(x=>'<option value="'+x.id+'">'+x.name+'</option>').join(''); sel.value=SESS.rows[i].id;
    sel.addEventListener('change',()=>{SESS.rows[i].id=sel.value; SESS.rows[i].name=DBMAP()[sel.value].name; sessRecalc(i); saveSESS(); row.querySelector('.r-vol').textContent=fmt(SESS.rows[i].vol); row.querySelector('.r-pct').textContent=fmt(SESS.rows[i].pct);});
    function bind(inp,key){inp.addEventListener('input',()=>{SESS.rows[i][key]=inp.value; sessRecalc(i); saveSESS(); row.querySelector('.r-vol').textContent=fmt(SESS.rows[i].vol); row.querySelector('.r-pct').textContent=fmt(SESS.rows[i].pct);})}
    bind(row.querySelector('.r-gross'),'gross'); bind(row.querySelector('.r-htot'),'hTot'); bind(row.querySelector('.r-hliq'),'hLiq');
    row.querySelector('[data-del]').addEventListener('click',()=>sessDel(i));
  })(rows[j])}
}

// экспорт
function escCSV(s){s=String(s).replace(/"/g,'""');return /["\n\r,;]/.test(s)?('"'+s+'"'):s}
function toCSV(rows,delim){var BOM='\ufeff';return BOM+rows.map(r=>r.map(x=>escCSV(x)).join(delim)).join('\r\n')+'\r\n'}
function exportCSV(filename,rows,delim){var blob=new Blob([toCSV(rows,delim||',')],{type:'text/csv;charset=utf-8'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},200)}
function detectDelim(line){var c1=(line.match(/,/g)||[]).length,c2=(line.match(/;/g)||[]).length;return c2>c1?';':','}
function parseCSV(text){
  var rows=[],row=[],field='',inQ=false,delim=detectDelim((text.split(/\r?\n/)[0]||'')); 
  for(var i=0;i<text.length;i++){var ch=text[i];
    if(inQ){ if(ch=='"'){ if(text[i+1]=='"'){field+='"';i++} else inQ=false } else field+=ch }
    else{ if(ch=='"') inQ=true; else if(ch===delim){row.push(field);field=''} else if(ch=='\n'){row.push(field);rows.push(row);row=[];field=''} else if(ch!='\r'){field+=ch} }
  }
  if(field!==''||row.length){row.push(field);rows.push(row)}
  return rows.filter(r=>r.join('').trim()!=='')
}

// импорт/экспорт БД + удаление позиции
function exportDB(){
  var rows=[['id','name','category','subcat','cap_ml','abv_pct','tare_g']]; 
  DB.forEach(b=>rows.push([b.id,b.name,b.category,b.subcat,b.cap_ml,b.abv_pct,b.tare_g]));
  exportCSV('barboss-db.csv',rows,$('csv-delim').value||',')
}
function importCSVFile(file){
  var fr=new FileReader(); fr.onload=function(){
    var rows=parseCSV(fr.result||''); if(!rows.length){$('db-msg').textContent='CSV пуст';return}
    var head=rows[0].map(s=>String(s||'').trim().toLowerCase());
    var idx={name:head.indexOf('name'),category:head.indexOf('category'),subcat:head.indexOf('subcat'),cap_ml:head.indexOf('cap_ml'),abv_pct:head.indexOf('abv_pct'),tare_g:head.indexOf('tare_g')};
    var added=0,dup=0;
    for(var r=1;r<rows.length;r++){
      var rw=rows[r]; var name=rw[idx.name]; if(!name) continue;
      var cat=rw[idx.category]||'Другое', sub=rw[idx.subcat]||'', cap=Number(rw[idx.cap_ml]||0), abv=Number(rw[idx.abv_pct]||0), tare=Number(rw[idx.tare_g]||0);
      var key=uniqKey(name,cat,sub), exists=DB.some(x=>uniqKey(x.name,x.category,x.subcat)===key);
      if(exists){dup++}else{DB.push({id:slug(name),name:name,category:cat,subcat:sub,cap_ml:cap,abv_pct:abv,tare_g:tare}); added++}
    }
    saveDB(); renderDBAccordion(); $('db-msg').textContent='Импорт: добавлено '+added+', дубликатов '+dup;
  }; fr.readAsText(file,'utf-8')
}
function deleteBottle(id){
  var b=DBMAP()[id]; if(!b) return;
  if(!confirm('Удалить «'+b.name+'» из базы?')) return;
  DB = DB.filter(x=>x.id!==id); saveDB(); renderDBAccordion();
}

// компактная БД: аккордеон
function renderDBAccordion(){
  var q=String($('db-search').value||'').toLowerCase();
  var data={}; // category -> subcat -> [items]
  DB.forEach(b=>{
    if(q && !b.name.toLowerCase().includes(q)) return;
    if(!data[b.category]) data[b.category]={_count:0};
    if(!data[b.category][b.subcat]) data[b.category][b.subcat]=[];
    data[b.category][b.subcat].push(b); data[b.category]._count++;
  });
  var html='';
  Object.keys(data).sort().forEach(cat=>{
    var groups=data[cat]; var count=groups._count||0;
    html+='<details><summary><span class="cat-title">'+cat+'</span><span class="muted">('+count+')</span></summary>';
    Object.keys(groups).filter(k=>k!=='_count').sort().forEach(sub=>{
      var arr=groups[sub].slice().sort((a,b)=>a.name.localeCompare(b.name));
      html+='<div class="subgroup"><div class="sub-title">'+(sub||'Без подкатегории')+' <span class="muted">('+arr.length+')</span></div>';
      arr.forEach(b=>{
        html+='<div class="db-item">'+
              '<div class="db-fields">'+
              '<div style="font-weight:700">'+b.name+'</div>'+
              '<span class="badge">'+b.cap_ml+' мл</span>'+
              '<span class="badge">'+b.abv_pct+'%</span>'+
              '<span class="badge">'+b.tare_g+' г</span>'+
              '</div>'+
              '<div class="db-actions">'+
              '<button class="small danger" data-del="'+b.id+'">Удалить</button>'+
              '</div>'+
              '</div>';
      });
      html+='</div>';
    });
    html+='</details>';
  });
  $('db-accordion').innerHTML=html || '<div class="muted">Нет результатов</div>';
  qsa('[data-del]').forEach(btn=>btn.addEventListener('click',()=>deleteBottle(btn.getAttribute('data-del'))));
}

// модал «добавить»
function catsOptionsHtml(){return Object.keys(CATEGORIES).map(c=>'<option>'+c+'</option>').join('')}
function subsOptionsHtml(cat){return (CATEGORIES[cat]||[]).map(s=>'<option>'+s+'</option>').join('')}
function openModal(){$('m-cat').innerHTML=catsOptionsHtml();$('m-sub').innerHTML=subsOptionsHtml($('m-cat').value);$('m-name').value='';$('m-cap').value='';$('m-abv').value='';$('m-tare').value='';$('m-msg').textContent='';$('modal').classList.remove('hidden')}
function closeModal(){$('modal').classList.add('hidden')}
function addBottle(){
  var cat=$('m-cat').value, sub=$('m-sub').value, name=$('m-name').value, cap=Number($('m-cap').value), abv=Number($('m-abv').value), tare=Number($('m-tare').value);
  if(!name||!cap||!abv||!tare){$('m-msg').textContent='Заполните все поля';return}
  var key=uniqKey(name,cat,sub); for(var i=0;i<DB.length;i++){if(uniqKey(DB[i].name,DB[i].category,DB[i].subcat)===key){$('m-msg').textContent='Такая бутылка уже существует';return}}
  DB.push({id:slug(name),name:name,category:cat,subcat:sub,cap_ml:cap,abv_pct:abv,tare_g:tare}); saveDB(); renderDBAccordion(); fillBottles(); $('m-msg').textContent='Сохранено'; setTimeout(closeModal,350)
}

// калькуляция + автодобавление в сессию
function calculate(){
  if(!validateCalc())return;
  var b=DBMAP()[$('bottle-select').value]; if(!b){$('note').textContent='Выберите бутылку';return}
  var gross=Number($('gross').value), hTot=Number($('hTot').value), hLiq=Number($('hLiq').value);
  var net=Math.max(0,gross-b.tare_g), vM=vMass(net,b.abv_pct), vG=vGeom(b.cap_ml,hLiq,hTot);
  var V=(vM>0&&vG>0)?(vM+vG)/2:(vM>0?vM:vG);
  V=Math.max(0,Math.min(b.cap_ml,V)); var pct=b.cap_ml?Math.max(0,Math.min(100,V/b.cap_ml*100)):0;
  $('res').innerHTML='<div class="big">≈ '+fmt(V)+' мл</div><div class="kv"><span class="badge">по массе: '+fmt(vM)+' мл</span><span class="badge">по высоте: '+fmt(vG)+' мл</span><span class="badge">заполнено ≈ '+fmt(pct)+'%</span></div>';
  if($('auto-session').checked){ if(!SESS.id) sessNew(); SESS.rows.push({id:b.id,name:b.name,gross:gross,hTot:hTot,hLiq:hLiq,vol:V,pct:pct}); saveSESS(); renderSess(); }
}

// инициализация
function init(){
  // профили
  renderProfiles(); loadSessionForActive();

  // калькулятор
  fillCats(); fillSubs(); fillBottles(); loadCalcState();

  // база
  renderDBAccordion();

  // автодобавление — по умолчанию включено
  var AUTO=getStore('bb_auto_session',true); $('auto-session').checked=!!AUTO;
  $('auto-session').addEventListener('change',function(){setStore('bb_auto_session',this.checked)});
}
init();

// события
document.querySelector('[data-tab="calc"]').addEventListener('click',()=>switchTab('calc'));
document.querySelector('[data-tab="db"]').addEventListener('click',()=>switchTab('db'));
document.querySelector('[data-tab="session"]').addEventListener('click',()=>switchTab('session'));
function switchTab(key){['calc','db','session'].forEach(id=>{$('tab-'+id).classList.toggle('hidden',id!==key)}); qsa('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===key))}

$('cat-select').addEventListener('change',()=>{fillSubs(); fillBottles(); saveCalcState()});
$('subcat-select').addEventListener('change',()=>{fillBottles(); saveCalcState()});
$('search-bottle').addEventListener('input',()=>{fillBottles(); saveCalcState()});
$('bottle-select').addEventListener('change',e=>loadPassport(e.target.value));
qsa('#gross,#hTot,#hLiq').forEach(el=>el.addEventListener('input',()=>{validateCalc(); saveCalcState()}));
$('calc').addEventListener('click',calculate);
$('btn-refresh').addEventListener('click',()=>{location.replace(location.pathname+'?v='+VER.replace(/\./g,'')+'-'+Date.now())});

// модал
$('btn-add-bottle').addEventListener('click',openModal); $('db-add').addEventListener('click',openModal);
$('m-cat').addEventListener('change',()=>{$('m-sub').innerHTML=subsOptionsHtml($('m-cat').value)});
$('m-save').addEventListener('click',addBottle); $('m-cancel').addEventListener('click',closeModal);

// база
$('db-export-csv').addEventListener('click',exportDB);
$('db-import-csv').addEventListener('click',()=>$('file-csv').click());
$('file-csv').addEventListener('change',function(){if(this.files&&this.files[0]) importCSVFile(this.files[0]); this.value=''});
$('db-search').addEventListener('input',renderDBAccordion);

// сессия
$('sess-new').addEventListener('click',sessNew);
$('sess-add-row').addEventListener('click',sessAddRow);
$('sess-export-csv').addEventListener('click',()=>{var rows=[['#','name','gross_g','height_cm','level_cm','volume_ml','percent']]; for(var i=0;i<SESS.rows.length;i++){var r=SESS.rows[i]; rows.push([i+1,r.name,r.gross,r.hTot,r.hLiq,fmt(r.vol),fmt(r.pct)])} exportCSV('barboss-session.csv',rows,$('csv-delim2').value||',')});
$('sess-search').addEventListener('input',()=>sessBottleList($('sess-search').value));

})();
</script>
</body>
</html>
